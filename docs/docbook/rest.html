<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.4: http://docutils.sourceforge.net/" />
<title>rsnapshot HOWTO</title>
<meta name="author" content="Nathan Rosenquist &lt;nathan&#64;rsnapshot.org&gt;" />
<meta name="date" content="2004-01-20" />
<meta name="copyright" content="2005 Nathan Rosenquist" />
<style type="text/css">

/*
:Author: David Goodger
:Contact: goodger@users.sourceforge.net
:Date: $Date: 2006/11/14 14:44:31 $
:Revision: $Revision: 1.1 $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin-left: 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left {
  clear: left }

img.align-right {
  clear: right }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font-family: serif ;
  font-size: 100% }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em ;
  background-color: #eeeeee }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

tt.docutils {
  background-color: #eeeeee }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="rsnapshot-howto">
<h1 class="title">rsnapshot HOWTO</h1>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr><th class="docinfo-name">Author:</th>
<td>Nathan Rosenquist &lt;<a class="reference" href="mailto:nathan&#64;rsnapshot.org">nathan&#64;rsnapshot.org</a>&gt;</td></tr>
<tr><th class="docinfo-name">Date:</th>
<td>2004-01-20</td></tr>
<tr><th class="docinfo-name">Copyright:</th>
<td>2005 Nathan Rosenquist</td></tr>
</tbody>
</table>
<div class="abstract topic">
<p class="topic-title first">Abstract</p>
<p>rsnapshot is a filesystem backup utility based on rsync. Using
rsnapshot, it is possible to take snapshots of your filesystems at
different points in time. Using hard links, rsnapshot creates the
illusion of multiple full backups, while only taking up the space
of one full backup plus differences. When coupled with ssh, it is
possible to take snapshots of remote filesystems as well. This
document is a tutorial in the installation and configuration of
rsnapshot.</p>
</div>
<!-- comment:

This document is marked up in reStructured Text format.
See http://docutils.sf.net/ for more information. -->
<div class="contents topic">
<p class="topic-title first"><a id="contents" name="contents">Contents</a></p>
<ul class="simple">
<li><a class="reference" href="#introduction" id="id3" name="id3">Introduction</a><ul>
<li><a class="reference" href="#what-you-will-need" id="id4" name="id4">What you will need</a></li>
<li><a class="reference" href="#copyright-and-license" id="id5" name="id5">Copyright and License</a></li>
<li><a class="reference" href="#disclaimer" id="id6" name="id6">Disclaimer</a></li>
<li><a class="reference" href="#feedback" id="id7" name="id7">Feedback</a></li>
</ul>
</li>
<li><a class="reference" href="#motivation" id="id8" name="id8">Motivation</a></li>
<li><a class="reference" href="#installation" id="id9" name="id9">Installation</a><ul>
<li><a class="reference" href="#second-version-for-the-impatient" id="id10" name="id10">30 second version (for the impatient)</a></li>
<li><a class="reference" href="#untar-the-source-code-package" id="id11" name="id11">Untar the source code package</a></li>
<li><a class="reference" href="#change-to-the-source-directory" id="id12" name="id12">Change to the source directory</a></li>
<li><a class="reference" href="#decide-where-you-want-to-install" id="id13" name="id13">Decide where you want to install</a></li>
<li><a class="reference" href="#run-the-configure-script" id="id14" name="id14">Run the configure script</a></li>
<li><a class="reference" href="#install-the-program" id="id15" name="id15">Install the program</a></li>
</ul>
</li>
<li><a class="reference" href="#configuration" id="id16" name="id16">Configuration</a><ul>
<li><a class="reference" href="#create-the-config-file" id="id17" name="id17">Create the config file</a></li>
<li><a class="reference" href="#where-to-go-for-more-info" id="id18" name="id18">Where to go for more info</a></li>
<li><a class="reference" href="#modifying-the-config-file" id="id19" name="id19">Modifying the config file</a><ul>
<li><a class="reference" href="#cmd-cp" id="id20" name="id20">cmd_cp</a></li>
<li><a class="reference" href="#cmd-rsync" id="id21" name="id21">cmd_rsync</a></li>
<li><a class="reference" href="#cmd-ssh" id="id22" name="id22">cmd_ssh</a></li>
<li><a class="reference" href="#cmd-logger" id="id23" name="id23">cmd_logger</a></li>
<li><a class="reference" href="#cmd-du" id="id24" name="id24">cmd_du</a></li>
<li><a class="reference" href="#link-dest" id="id25" name="id25">link_dest</a></li>
<li><a class="reference" href="#interval" id="id26" name="id26">interval</a></li>
<li><a class="reference" href="#backup" id="id27" name="id27">backup</a></li>
<li><a class="reference" href="#backup-script" id="id28" name="id28">backup_script</a></li>
</ul>
</li>
<li><a class="reference" href="#testing-your-config-file" id="id29" name="id29">Testing your config file</a></li>
</ul>
</li>
<li><a class="reference" href="#automation" id="id30" name="id30">Automation</a></li>
<li><a class="reference" href="#how-it-works" id="id31" name="id31">How it works</a></li>
<li><a class="reference" href="#restoring-backups" id="id32" name="id32">Restoring backups</a><ul>
<li><a class="reference" href="#root-only" id="id33" name="id33">root only</a></li>
<li><a class="reference" href="#all-users" id="id34" name="id34">All users</a></li>
</ul>
</li>
<li><a class="reference" href="#conclusion" id="id35" name="id35">Conclusion</a></li>
<li><a class="reference" href="#more-resources" id="id36" name="id36">More resources</a></li>
</ul>
</div>
<div class="section">
<h1><a id="introduction" name="introduction">Introduction</a></h1>
<p>rsnapshot is a filesystem backup utility based on rsync. Using
rsnapshot, it is possible to take snapshots of your filesystems at
different points in time. Using hard links, rsnapshot creates the
illusion of multiple full backups, while only taking up the space of
one full backup plus differences. When coupled with ssh, it is
possible to take snapshots of remote filesystems as well.</p>
<p>rsnapshot is written in Perl, and depends on rsync. OpenSSH, GNU cp,
GNU du, and the BSD logger program are also recommended, but not
required. All of these should be present on most Linux
systems. rsnapshot is written with the lowest common denominator in
mind. It only requires at minimum Perl 5.004 and rsync. As a result of
this, it works on pretty much any UNIX-like system you care to throw
at it. It has been successfully tested with Perl 5.004 through 5.8.2,
on Debian, Redhat, Fedora, Solaris, Mac OS X, FreeBSD, OpenBSD,
NetBSD, and IRIX.</p>
<p>The latest version of the program and this document can always be
found at <a class="reference" href="http://www.rsnapshot.org/">http://www.rsnapshot.org/</a>.</p>
<div class="section">
<h2><a id="what-you-will-need" name="what-you-will-need">What you will need</a></h2>
<p>At a minimum: perl, rsync</p>
<p>Optionally: ssh, logger, GNU cp, GNU du</p>
<p>Additionally, it will help if you have reasonably good sysadmin skills.</p>
</div>
<div class="section">
<h2><a id="copyright-and-license" name="copyright-and-license">Copyright and License</a></h2>
<p>This document, rsnapshot HOWTO, is copyrighted Â© 2005 by Nathan
Rosenquist. You can redistribute it and/or modify it under the terms
of the GNU General Public License as published by the Free Software
Foundation; either version 2 of the License, or (at your option) any
later version. A copy of the license is available at
<a class="reference" href="http://www.gnu.org/">http://www.gnu.org/</a> copyleft/gpl.html.</p>
</div>
<div class="section">
<h2><a id="disclaimer" name="disclaimer">Disclaimer</a></h2>
<p>No liability for the contents of this document can be accepted. Use
the concepts, examples and information at your own risk. There may be
errors and inaccuracies, that could be damaging to your
system. Proceed with caution, and although this is highly unlikely,
the author(s) do not take any responsibility.</p>
<p>All copyrights are held by their by their respective owners, unless
specifically noted otherwise. Use of a term in this document should
not be regarded as affecting the validity of any trademark or service
mark. Naming of particular products or brands should not be seen as
endorsements.</p>
</div>
<div class="section">
<h2><a id="feedback" name="feedback">Feedback</a></h2>
<p>Feedback is most certainly welcome for this document. Send your
additions, comments and criticisms to the following email address:
<a class="reference" href="mailto:nathan&#64;rsnapshot.org">nathan&#64;rsnapshot.org</a>.</p>
</div>
</div>
<div class="section">
<h1><a id="motivation" name="motivation">Motivation</a></h1>
<p>I originally used Mike Rubel's shell scripts to do rsync snapshots a
while back. These worked very well, but there were a number of things
that I wanted to improve upon. I had to write two shell scripts that
were customized for my server. If I wanted to change the number of
intervals stored, or the parts of the filesystem that were archived,
that meant manually editing these shell scripts. If I wanted to
install them on a different server with a different configuration,
this meant manually editing the scripts for the new server, and hoping
the logic and the sequence of operations was correct. Also, I was
doing all the backups locally, on a single machine, on a single hard
drive (just to protect from dumb user mistakes like deleting
files). Never the less, I continued on with this system for a while,
and it did work very well.</p>
<p>Several months later, the IDE controller on my web server failed
horribly (when I typed /sbin/shutdown, it said the command was not
found). I was then faced with what was in the back of my mind all
along: I had not been making regular remote backups of my server, and
the local backups were of no use to me since the entire drive was
corrupted. The reason I had only been making sporadic, partial remote
backups is that they weren't automatic and effortless. Of course, this
was no one's fault but my own, but I got frustrated enough to write a
tool that would make automated remote snapshots so easy that I
wouldn't ever have to worry about them again. This goal has long been
reached, but work on rsnapshot still continues as people submit
patches, request features, and ways are found to improve the program.</p>
</div>
<div class="section">
<h1><a id="installation" name="installation">Installation</a></h1>
<p>This section will walk you through the installation of rsnapshot, step
by step. This is not the only way to do it, but it is a way that works
and that is well documented. Feel free to improvise if you know what
you're doing.</p>
<p>This guide assumes you are installing rsnapshot 1.2.0 for the first
time. If you are upgrading from an earlier version, please read the
INSTALL file that comes with the source distribution instead.</p>
<div class="section">
<h2><a id="second-version-for-the-impatient" name="second-version-for-the-impatient">30 second version (for the impatient)</a></h2>
<pre class="literal-block">
./configure --sysconfdir=/etc
su
make install
cp /etc/rsnapshot.conf.default /etc/rsnapshot.conf
</pre>
<p>The rest of this section is the long version.</p>
</div>
<div class="section">
<h2><a id="untar-the-source-code-package" name="untar-the-source-code-package">Untar the source code package</a></h2>
<pre class="literal-block">
tar xzvf rsnapshot-1.2.0.tar.gz
</pre>
<p>If you don't have GNU tar, you may have to do this in two steps
instead:</p>
<pre class="literal-block">
gunzip rsnapshot-1.2.0.tar.gz
tar xvf rsnapshot-1.2.0.tar
</pre>
</div>
<div class="section">
<h2><a id="change-to-the-source-directory" name="change-to-the-source-directory">Change to the source directory</a></h2>
<pre class="literal-block">
cd rsnapshot-1.2.0/
</pre>
</div>
<div class="section">
<h2><a id="decide-where-you-want-to-install" name="decide-where-you-want-to-install">Decide where you want to install</a></h2>
<p>By default, the installation procedure will install all files under
/usr/local. For this tutorial, this will be OK except we will install
the config file under /etc.</p>
<p>We are assuming that rsync, ssh, logger, and du are all in your search
path. If this is not the case, you can specify the path to any of
these programs using the typical Autoconf
--with-program=/path/to/program syntax. For example, if Perl was in
/opt/bin/perl and rsync was in /home/me/bin/rsync, you could run
configure like:</p>
<pre class="literal-block">
./configure --with-perl=/opt/bin/perl --with-rsync=/home/me/bin/rsync
</pre>
</div>
<div class="section">
<h2><a id="run-the-configure-script" name="run-the-configure-script">Run the configure script</a></h2>
<p>This will poke and prod your system to figure out where the various
external programs that rsnapshot depends on live. It also generates
the Makefile that we will use to install the program. The configure
script accepts arguments that can be used to tell it where to install
the program, and also where to find the supporting programs. For this
installation, the only non-default option we want is to put the config
file in the /etc directory. To do this, run this command at the
shell:</p>
<pre class="literal-block">
./configure --sysconfdir=/etc
</pre>
<p>If all goes well, you're ready to install the program. If there was a
problem, it should be descriptive. Most likely a problem would be the
result of something that was required and not found (like rsync or
perl). If this happens, you must figure out where the missing program
is located on your system, or install it if necessary. If you know
where it is but configure couldn't find it, you can specify the path
using the --with-program=/path/to/program options described above.</p>
</div>
<div class="section">
<h2><a id="install-the-program" name="install-the-program">Install the program</a></h2>
<p>If you've followed these instructions so far, you will have configured
rsnapshot to be installed under /usr/local, with the config file in
/etc. Under these circumstances, it will be necessary to become root
to install the program. Now is the time to do so. You will, of course,
need the root password to do this:</p>
<pre class="literal-block">
su
</pre>
<p>This will prompt you for the root password.</p>
<p>Now, to install rsnapshot, run the following command:</p>
<pre class="literal-block">
make install
</pre>
<p>This will install rsnapshot with all the settings you specified in the
./configure stage. If all goes well, you will have the following files
on your system:</p>
<blockquote>
<dl class="docutils">
<dt>/usr/local/bin/rsnapshot</dt>
<dd>The rsnapshot program</dd>
<dt>/usr/local/man/man1/rsnapshot.1</dt>
<dd>Man page</dd>
<dt>/etc/rsnapshot.conf.default</dt>
<dd>The example config file</dd>
</dl>
</blockquote>
<p>If you decide later that you don't want rsnapshot on your system
anymore, simply remove the files listed above, or run <tt class="docutils literal"><span class="pre">make</span>
<span class="pre">uninstall</span></tt> in the same source directory you installed from. Of
course, if you installed with different options, the location of these
files may be different.</p>
</div>
</div>
<div class="section">
<h1><a id="configuration" name="configuration">Configuration</a></h1>
<div class="section">
<h2><a id="create-the-config-file" name="create-the-config-file">Create the config file</a></h2>
<p>In the install process, the config file is not created or
installed. However, a working example is provided that you can
copy. To copy the example config file into the location rsnapshot will
be looking for the real config file:</p>
<pre class="literal-block">
cp /etc/rsnapshot.conf.default /etc/rsnapshot.conf
</pre>
<p>As a general rule, you should avoid modifying
/etc/rsnapshot.conf.default, simply because it is a working example
that you may wish to refer to later. Also, if you perform an upgrade,
the rsnapshot.conf.default file will always be upgraded to the latest
version, while your real config file will be safe out of harm's
way. Please note that if you run <tt class="docutils literal"><span class="pre">make</span> <span class="pre">upgrade</span></tt> during an upgrade,
your rsnapshot.conf may be modified slightly, and the original will
then be saved in rsnapshot.conf.backup in the same directory.</p>
</div>
<div class="section">
<h2><a id="where-to-go-for-more-info" name="where-to-go-for-more-info">Where to go for more info</a></h2>
<p>The rsnapshot.conf config file is well commented, and much of it
should be fairly self-explanatory. For a full reference of all the
various options, please consult the rsnapshot man page. Type:</p>
<pre class="literal-block">
man rsnapshot
</pre>
<p>This will give you the complete documentation. However, it assumes
that you already know what you're doing to a certain extent. If you
just want to get something up and running, this tutorial is a better
place to start. If your system can't find the man page, /usr/local/man
probably isn't in your $MANPATH environmental variable. This is beyond
the scope of this document, but if it isn't working for you, you can
always read the newest man page on the rsnapshot web site at
<a class="reference" href="http://www.rsnapshot.org/">http://www.rsnapshot.org/</a></p>
</div>
<div class="section">
<h2><a id="modifying-the-config-file" name="modifying-the-config-file">Modifying the config file</a></h2>
<p>In this example, we will be using the /.snapshots/ directory to hold
the filesystem snapshots. This is referred to as the &quot;snapshot
root&quot;. Feel free to put this anywhere you have lots of free disk
space. However, the examples in this document assume you have not
changed this parameter, so you will have to substitute this in your
commands if you put it somewhere else.</p>
<p>Also please note that fields are separated by tabs, not spaces. The
reason for this is so it's easier to specify file paths with spaces in
them.</p>
<div class="section">
<h3><a id="cmd-cp" name="cmd-cp">cmd_cp</a></h3>
<p>If enabled, the cmd_cp parameter should contain the path to the GNU cp
program on your filesystem. If you are using Linux, be sure to
uncomment this by removing the octothorpe (#) in front of it. If you
are using BSD, Solaris, IRIX, or most other UNIX variants, you should
leave this commented out.</p>
<p>What makes GNU cp so special is that unlike the traditional UNIX
cp, it has the ability to make recursive &quot;copies&quot; of directories
as hard links.</p>
<p>If you don't have GNU cp, there is a subroutine in rsnapshot that
somewhat approximates this functionality (although it won't
support more esoteric files such as device nodes, FIFOs, sockets,
etc). This gets followed up by another call to rsync, which
transfers the remaining special files, if any. In this way,
rsnapshot can support all file types on every platform.</p>
<p>The rule of thumb is that if you're on a Linux system, leave
cmd_cp enabled. If you aren't on a Linux system, leave cmd_cp
disabled. There are reports of GNU cp working on BSD and other
non-Linux platforms, but there have also been some cases where
problems have been encountered. If you enable cmd_cp on a
non-Linux platform, please let the mailing list know how it worked
out for you.</p>
</div>
<div class="section">
<h3><a id="cmd-rsync" name="cmd-rsync">cmd_rsync</a></h3>
<p>The cmd_rsync parameter must not be commented out, and it must
point to a working version of rsync. If it doesn't, the program
just will not work at all.</p>
<p>Please note that if you are using IRIX, there is another program
named rsync that is different than the &quot;real&quot; rsync most people
know of. If you're on an IRIX machine, you should double check
this.</p>
</div>
<div class="section">
<h3><a id="cmd-ssh" name="cmd-ssh">cmd_ssh</a></h3>
<p>If you have ssh installed on your system, you will want to
uncomment the cmd_ssh parameter. By enabling ssh, you can take
snapshots of any number of remote systems. If you don't have ssh,
or plan to only take snapshots of the local filesystem, you may
safely leave this commented out.</p>
</div>
<div class="section">
<h3><a id="cmd-logger" name="cmd-logger">cmd_logger</a></h3>
<p>The cmd_logger parameter specifies the path to the logger
program. logger is a command line interface to syslog. See the
logger man page for more details. logger should be a standard part
of most UNIX-like systems. It appears to have remained unchanged
since about 1993, which is good for cross-platform stability. If
you comment out this parameter, it will disable syslog support in
rsnapshot. It is recommended that you leave this enabled.</p>
</div>
<div class="section">
<h3><a id="cmd-du" name="cmd-du">cmd_du</a></h3>
<p>The cmd_du parameter specifies the path to the du program. du is a
command line tool that reports on disk usage. rsnapshot uses du to
generate reports about the actual amount of disk space taken up,
which is otherwise difficult to estimate because of all the hard
links.</p>
<p>If you comment this out, rsnapshot will try to use the version of
du it finds in your path, if possible. The GNU version of du is
recommended, since it has the best selection of features, and
supports the most options. The BSD version also seems to work,
although some versions don't support the -h flag. Solaris du does
not work at all, because it doesn't support the -c parameter.</p>
</div>
<div class="section">
<h3><a id="link-dest" name="link-dest">link_dest</a></h3>
<p>If you have rsync version 2.5.7 or later, you may want to enable
this. With link_dest enabled, rsnapshot relies on rsync to create
recursive hard links, overriding GNU cp in most, but not all,
cases. With link_dest enabled, every single file on your system
can be backed up in one pass, on any operating system. To get the
most out of rsnapshot on non-Linux platforms, link_dest should be
enabled. Be advised, however, that if a remote host is unavailable
during a backup, rsnapshot will take an extra step and roll back
the files from the previous backup. Using GNU cp, this would not
be necessary.</p>
</div>
<div class="section">
<h3><a id="interval" name="interval">interval</a></h3>
<p>rsnapshot has no idea how often you want to take
snapshots. Everyone's backup scheme may be different. In order to
specify how much data to save, you need to tell rsnapshot which
&quot;intervals&quot; to keep, and how many of each. An interval, in the
context of the rsnapshot config file, is a unit of time
measurement. These can actually be named anything (as long as it's
alphanumeric, and not a reserved word), but by convention we will
call ours hourly and daily. In this example, we want to take a
snapshot every four hours, or six times a day (these are the
hourly intervals). We also want to keep a second set, which are
taken once a day, and stored for a week (or seven days). This
happens to be the default, so as you can see the config file
reads:</p>
<pre class="literal-block">
interval    hourly  6
interval    daily   7
</pre>
<p>It also has some other entries, but you can either ignore them or
comment them out for now.</p>
<p>Please note that the hourly interval is specified first. This is
very important. The first interval line is assumed to be the
smallest unit of time, with each additional line getting
successively larger. Thus, if you add a yearly interval, it should
go at the bottom, and if you add a minutes interval, it should go
before hourly. It's also worth noting that the snapshots get
&quot;pulled up&quot; from the smallest interval to the largest. In this
example, the daily snapshots get pulled from the oldest hourly
snapshot, not directly from the main filesystem.</p>
</div>
<div class="section">
<h3><a id="backup" name="backup">backup</a></h3>
<p>Please note that the destination paths specified here are based on
the assumption that the --relative flag is being passed to rsync
via the rsync_long_args parameter. If you are installing for the
first time, this is the default setting. If you upgraded from a
previous version, please read the INSTALL file that came with the
source distribution for more information.</p>
<p>This is the section where you tell rsnapshot what files you actually
want to back up. You put a &quot;backup&quot; parameter first, followed by the
full path to the directory or network path you're backing up. The
third column is the relative path you want to back up to inside the
snapshot root. Let's look at an example:</p>
<pre class="literal-block">
backup      /etc/      localhost/
</pre>
<p>In this example, backup tells us it's a backup point. /etc/ is the
full path to the directory we want to take snapshots of, and
localhost/ is a directory inside the snapshot_root we're going to put
them in. Using the word localhost as the destination directory is just
a convention. You might also choose to use the server's fully
qualified domain name instead of localhost. If you are taking
snapshots of several machines on one dedicated backup server, it's a
good idea to use their various hostnames as directories to keep track
of which files came from which server.</p>
<p>In addition to full paths on the local filesystem, you can also backup
remote systems using rsync over ssh. If you have ssh installed and
enabled (via the cmd_ssh parameter), you can specify a path like:</p>
<pre class="literal-block">
backup      root&#64;example.com:/etc/     example.com/
</pre>
<p>This behaves fundamentally the same way, but you must take a few extra
things into account.</p>
<ul class="simple">
<li>The ssh daemon must be running on example.com</li>
<li>You must have access to the account you specify the remote machine,
in this case the root user on example.com.</li>
<li>You must have key-based logins enabled for the root user at
example.com, without passphrases. If you wanted to perform backups
as another user, you could specify the other user instead of root
for the source (i.e. <a class="reference" href="mailto:user&#64;domain.com">user&#64;domain.com</a>). Please note that allowing
remote logins with no passphrase is a security risk that may or may
not be acceptable in your situation. Make sure you guard access to
the backup server very carefully! For more information on how to set
this up, please consult the ssh man page, or a tutorial on using ssh
public and private keys. You will find that the key based logins are
better in many ways, not just for rsnapshot but for convenience and
security in general. <a class="reference" href="http://www.jdmz.net/rsnapshot">Troy Johnson</a>'s excellent tutorial on using
nifty ssh features for secure snapshots which, in case his site ever
suffers a mishap, is mirrored <a class="reference" href="http://www.rsnapshot.org/howto/using-rsnapshot-and-ssh.html">here</a> on this site.</li>
<li>This backup occurs over the network, so it may be slower. Since this
uses rsync, this is most noticeable during the first
backup. Depending on how much your data changes, subsequent backups
should go much, much faster since rsync only sends the differences
between files.</li>
</ul>
</div>
<div class="section">
<h3><a id="backup-script" name="backup-script">backup_script</a></h3>
<p>With this parameter, the second column is the full path to an
executable backup script, and the third column is the local path
you want to store it in (just like with the &quot;backup&quot;
parameter). For example:</p>
<pre class="literal-block">
backup_script      /usr/local/bin/backup_pgsql.sh       localhost/postgres/
</pre>
<p>In this example, rsnapshot will run the script
/usr/local/bin/backup_pgsql.sh in a temp directory, then sync the
results into the localhost/postgres/ directory under the snapshot
root. You can find the backup_pgsql.sh example script in the utils/
directory of the source distribution. Feel free to modify it for your
system.</p>
<p>Your backup script simply needs to dump out the contents of whatever
it does into it's current working directory. It can create as many
files and/or directories as necessary, but it should not put its files
in any pre-determined path. The reason for this is that rsnapshot
creates a temp directory, changes to that directory, runs the backup
script, and then syncs the contents of the temp directory to the local
path you specified in the third column. A typical backup script would
be one that archives the contents of a database. It might look like
this:</p>
<pre class="literal-block">
#!/bin/sh

/usr/bin/mysqldump -uroot mydatabase &gt; mydatabase.sql
/bin/chmod 644 mydatabase.sql
</pre>
<p>There are several example scripts in the utils/ directory of the
rsnapshot source distribution to give you more ideas.</p>
<p>Make sure the destination path you specify is unique. The backup
script will completely overwrite anything in the destination path, so
if you tried to specify the same destination twice, you would be left
with only the files from the last script. Fortunately, rsnapshot will
try to prevent you from doing this when it reads the config file.</p>
<p>Please remember that these backup scripts will be invoked as the user
running rsnapshot. In our example, this is root. Make sure your backup
scripts are owned by root, and not writable by anyone else. If you
fail to do this, anyone with write access to these backup scripts will
be able to put commands in them that will be run as the root user. If
they are malicious, they could take over your server.</p>
</div>
</div>
<div class="section">
<h2><a id="testing-your-config-file" name="testing-your-config-file">Testing your config file</a></h2>
<p>When you have made all your changes, you should verify that the config
file is syntactically valid, and that all the supporting programs are
where you think they are. To do this, run rsnapshot with the
configtest argument:</p>
<pre class="literal-block">
rsnapshot configtest
</pre>
<p>If all is well, it should say Syntax OK. If there's a problem, it
should tell you exactly what it is. Make sure your config file is
using tabs and not spaces, etc.</p>
<p>The final step to test your configuration is to run rsnapshot in test
mode. This will print out a verbose list of the things it will do,
without actually doing them. To do a test run, run this command:</p>
<pre class="literal-block">
rsnapshot -t hourly
</pre>
<p>This tells rsnapshot to simulate an &quot;hourly&quot; backup. It should print
out the commands it will perform when it runs for real. Please note
that the test output might be slightly different than the real
execution, but only because the test doesn't actually do things that
may be checked for later in the program. For example, if the program
will create a directory and then later test to see if that directory
exists, the test run might claim that it would create the directory
twice, since it didn't actually get created during the test. This
should be the only type of difference you will see while running a
test.</p>
</div>
</div>
<div class="section">
<h1><a id="automation" name="automation">Automation</a></h1>
<p>Now that you have your config file set up, it's time to set up
rsnapshot to be run from cron. As the root user, edit root's crontab
by typing:</p>
<pre class="literal-block">
crontab -e
</pre>
<p>You could alternately keep a crontab file that you load in, but the
concepts are the same. You want to enter the following information
into root's crontab:</p>
<pre class="literal-block">
0 */4 * * *       /usr/local/bin/rsnapshot hourly
30 23 * * *       /usr/local/bin/rsnapshot daily
</pre>
<p>It is usually a good idea to schedule the larger intervals to run a
bit before the lower ones. For example, in the crontab above, notice
that daily runs 30 minutes before hourly. This helps prevent race
conditions where the daily would try to run before the hourly job had
finished. This same strategy should be extended so that a weekly entry
would run before the daily and so on.</p>
</div>
<div class="section">
<h1><a id="how-it-works" name="how-it-works">How it works</a></h1>
<p>We have a snapshot root under which all backups are stored. By
default, this is the directory /.snapshots/. Within this directory,
other directories are created for the various intervals that have been
defined. In the beginning it will be empty, but once rsnapshot has
been running for a week, it should look something like this:</p>
<pre class="literal-block">
[root&#64;localhost]# ls -l /.snapshots/
drwxr-xr-x    7 root     root         4096 Dec 28 00:00 daily.0
drwxr-xr-x    7 root     root         4096 Dec 27 00:00 daily.1
drwxr-xr-x    7 root     root         4096 Dec 26 00:00 daily.2
drwxr-xr-x    7 root     root         4096 Dec 25 00:00 daily.3
drwxr-xr-x    7 root     root         4096 Dec 24 00:00 daily.4
drwxr-xr-x    7 root     root         4096 Dec 23 00:00 daily.5
drwxr-xr-x    7 root     root         4096 Dec 22 00:00 daily.6
drwxr-xr-x    7 root     root         4096 Dec 29 00:00 hourly.0
drwxr-xr-x    7 root     root         4096 Dec 28 20:00 hourly.1
drwxr-xr-x    7 root     root         4096 Dec 28 16:00 hourly.2
drwxr-xr-x    7 root     root         4096 Dec 28 12:00 hourly.3
drwxr-xr-x    7 root     root         4096 Dec 28 08:00 hourly.4
drwxr-xr-x    7 root     root         4096 Dec 28 04:00 hourly.5
</pre>
<p>Inside each of these directories is a &quot;full&quot; backup of that point in
time. The destination directory paths you specified under the backup
and backup_script parameters get stuck directly under these
directories. In the example:</p>
<pre class="literal-block">
backup          /etc/           localhost/
</pre>
<p>The /etc/ directory will initially get backed up into
/.snapshots/hourly.0/localhost/etc/</p>
<p>Each subsequent time rsnapshot is run with the hourly command, it will
rotate the hourly.X directories, and then &quot;copy&quot; the contents of the
hourly.0 directory (using hard links) into hourly.1.</p>
<p>When rsnapshot daily is run, it will rotate all the daily.X
directories, then copy the contents of hourly.5 into daily.0.</p>
<p>hourly.0 will always contain the most recent snapshot, and daily.6
will always contain a snapshot from a week ago. Unless the files
change between snapshots, the &quot;full&quot; backups are really just multiple
hard links to the same files. Thus, if your /etc/passwd file doesn't
change in a week, hourly.0/localhost/etc/passwd and
daily.6/localhost/etc /passwd will literally be the same exact
file. This is how rsnapshot can be so efficient on space. If the file
changes at any point, the next backup will unlink the hard link in
hourly.0, and replace it with a brand new file. This will now take
double the disk space it did before, but it is still considerably less
than it would be to have full unique copies of this file 13 times
over.</p>
<p>Remember that if you are using different intervals than the ones in
this example, the first interval listed is the one that gets updates
directly from the main filesystem. All subsequently listed intervals
pull from the previous intervals. For example, if you had weekly,
monthly, and yearly intervals defined (in that order), the weekly ones
would get updated directly from the filesystem, the monthly ones would
get updated from weekly, and the yearly ones would get updated from
monthly.</p>
</div>
<div class="section">
<h1><a id="restoring-backups" name="restoring-backups">Restoring backups</a></h1>
<p>When rsnapshot is first run, it will create the snapshot_root
directory (/.snapshots/ by default). It assigns this directory the
permissions 700, and for good reason. The snapshot root will probably
contain files owned by all sorts of users on your system. If any of
these files are writeable (and of course some of them will be), the
users will still have write access to their files. Thus, if they can
see the snapshots directly, they can modify them, and the integrity of
the snapshots can not be guaranteed.</p>
<p>For example, if a user had write permission to the backups and
accidentally ran rm -rf /, they would delete all their files in their
home directory and all the files they owned in the backups!</p>
<div class="section">
<h2><a id="root-only" name="root-only">root only</a></h2>
<p>The simplest, but least flexible solution, is to simply deny non-root
users access to the snapshot root altogether. The root user will still
have access of course, and as with all other aspects of system
administration, must be trusted not to go messing with things too
much. However, by simply denying access to everyone, the root user
will be the only one who can pull backups. This may or may not be
desirable, depending on your situation. For a small setup or a
single-user machine, this may be all you need.</p>
</div>
<div class="section">
<h2><a id="all-users" name="all-users">All users</a></h2>
<p>If users need to be able to pull their own backups, you will need to
do a little extra work up front (but probably less work in the long
run). The best way to do this seems to be creating a container
directory for the snapshot root with 700 permissions, giving the
snapshot root directory 755 permissions, and mounting the snapshot
root for the users read-only. This can be done over NFS and Samba, to
name two possibilities. Let's explore how to do this using NFS on a
single machine:</p>
<p>Set the snapshot_root variable in /etc/rsnapshot.conf equal to
/.private/.snapshots/</p>
<pre class="literal-block">
snapshot_root       /.private/.snapshots/
</pre>
<p>Create the container directory:</p>
<pre class="literal-block">
mkdir /.private/
</pre>
<p>Create the real snapshot root:</p>
<pre class="literal-block">
mkdir /.private/.snapshots/
</pre>
<p>Create the read-only snapshot root mount point:</p>
<pre class="literal-block">
mkdir /.snapshots/
</pre>
<p>Set the proper permissions on these new directories:</p>
<pre class="literal-block">
chmod 0700 /.private/
chmod 0755 /.private/.snapshots/
chmod 0755 /.snapshots/
</pre>
<p>In /etc/exports, add /.private/.snapshots/ as a read only NFS export:</p>
<pre class="literal-block">
/.private/.snapshots/  127.0.0.1(ro,no_root_squash)
</pre>
<p>In /etc/fstab, mount /.private/.snapshots/ read-only under
/.snapshots/</p>
<pre class="literal-block">
localhost:/.private/.snapshots/   /.snapshots/   nfs    ro   0 0
</pre>
<p>You should now restart your NFS daemon.</p>
<p>Now mount the read-only snapshot root:</p>
<pre class="literal-block">
mount /.snapshots/
</pre>
<p>To test this, go into the /.snapshots/ directory as root. It is set to
read-only, so even root shouldn't be able to write to it. As root,
try:</p>
<pre class="literal-block">
touch /.snapshots/testfile
</pre>
<p>This should fail, citing insufficient permissions. This is what you
want. It means that your users won't be able to mess with the
snapshots either.</p>
<p>Now, all your users have to do to recover old files is go into the
/.snapshots directory, select the interval they want, and browse
through the filesystem until they find the files they are looking
for. They can't modify anything in here because NFS will prevent them,
but they can copy anything that they had read permission for in the
first place.  All the regular filesystem permissions are still at
work, but the read-only NFS mount prevents any writes from happening.</p>
<p>Please note that some NFS configurations may prevent you from
accessing files that are owned by root and set to only be readable by
root. In this situation, you may wish to pull backups for root from
the &quot;real&quot; snapshot root, and let non-privileged users pull from the
read-only NFS mount.</p>
</div>
</div>
<div class="section">
<h1><a id="conclusion" name="conclusion">Conclusion</a></h1>
<p>If you followed the instructions in this document, you should now have
rsnapshot installed and set up to perform automatic backups of your
system. If it's not working, go back and trace your steps back to see
if you can isolate the problem.</p>
<p>The amount of disk space taken up will be equal to one full backup,
plus an additional copy of every file that is changed. There is also a
slight disk space overhead with creating multiple hard links, but it's
not very much. On my system, adding a second, completely identical 3
Gigabyte interval alongside the original one only added about 15
Megabytes.</p>
<p>You can use the du option to rsnapshot to generate disk usage
reports. To see the sum total of all space used, try:</p>
<pre class="literal-block">
rsnapshot du
</pre>
<p>If you were storing backups under localhost/home/ and wanted to see
how much this subdirectory takes up throughout all your backups, try
this instead:</p>
<pre class="literal-block">
rsnapshot du localhost/home/
</pre>
<p>The latest version of this document and the rsnapshot program can
always be found at <a class="reference" href="http://www.rsnapshot.org/">http://www.rsnapshot.org/</a></p>
</div>
<div class="section">
<h1><a id="more-resources" name="more-resources">More resources</a></h1>
<dl class="docutils">
<dt>Mike Rubel's original shell scripts, upon which this project is based</dt>
<dd><a class="reference" href="http://www.mikerubel.org/computers/rsync_snapshots/">http://www.mikerubel.org/computers/rsync_snapshots/</a></dd>
<dt>Perl</dt>
<dd><a class="reference" href="http://www.perl.org/">http://www.perl.org/</a></dd>
<dt>GNU cp and du (coreutils package)</dt>
<dd><a class="reference" href="http://www.gnu.org/software/coreutils/">http://www.gnu.org/software/coreutils/</a></dd>
<dt>rsync</dt>
<dd><a class="reference" href="http://rsync.samba.org/">http://rsync.samba.org/</a></dd>
<dt>OpenSSH</dt>
<dd><a class="reference" href="http://www.openssh.org/">http://www.openssh.org/</a></dd>
<dt>rsnapshot</dt>
<dd><a class="reference" href="http://www.rsnapshot.org/">http://www.rsnapshot.org/</a></dd>
</dl>
</div>
</div>
</body>
</html>
